stage('Start Monitoring Stack') {
    steps {
        script {
            // Start Prometheus and Grafana using Docker Compose
            sh '''
                docker-compose -f docker-compose-monitoring.yml up -d
                echo "Waiting 30 seconds for services to start..."
                sleep 30
            '''
        }
    }
}

stage('Configure Monitoring') {
    steps {
        script {
            // Add Jenkins as a target in Prometheus
            sh '''
                curl -X POST \
                http://localhost:9090/-/reload \
                -H 'Content-Type: application/json'
            '''
            
            // Import Jenkins dashboard in Grafana
            sh '''
                curl -X POST \
                http://admin:admin@localhost:3000/api/dashboards/import \
                -H 'Content-Type: application/json' \
                -d '{
                    "dashboard": {
                        "id": null,
                        "title": "Jenkins Metrics",
                        "tags": ["jenkins"],
                        "timezone": "browser",
                        "schemaVersion": 16,
                        "version": 0
                    },
                    "overwrite": true
                }'
            '''
        }
    }
}
